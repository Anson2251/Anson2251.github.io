<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <title>Sequence Calculator</title>

    <script>
        function getSequence(s) {
            //let s = [2, 9, 28, 65]
            let d1 = [s[1] - s[0], s[2] - s[1], s[3] - s[2]];
            let d2 = [d1[1] - d1[0], d1[2] - d1[1]];
            let d3 = [d2[1] - d2[0]];


            let isDouble = false;
            let isTrible = false;

            if (d2[0] === d2[1]) {
                isDouble = true;
                isTrible = false;
            } else {
                if (d3[0] || d3[0] === 0) {
                    isDouble = false;
                    isTrible = true;
                } else {
                    console.log("unknown sequence (exponent may > 3)");
                    return {
                        exp: 0
                    };
                }
            }


            let a = 0;
            let b = 0;
            let c = 0;
            let d = 0;

            if (isDouble) {
                a = d2[0] / 2;
                b = d1[0] - 3 * a;
                c = s[0] - a - b;
            } else if (isTrible) {
                a = d3[0] / 6;
                b = (d2[0] - 12 * a) / 2;
                c = d1[0] - (7 * a) - (3 * b);
                d = s[0] - a - b - c;
            }

            return {
                exp: (isDouble ? 2 : (isTrible ? 3 : 0)),
                a: a,
                b: b,
                c: c,
                d: d
            }
        }

        function calc(str){
            str = `[${str}]`;
            let sequence = JSON.parse(str);
            if(!sequence[0] && sequence[0] !== 0){
                alert("参数错误");
                return;
            }

            let result = getSequence(sequence);
            if(!result.exp){
                alert("错误，表达式次数可能超过3");
            }

            function getTerm(num, str, sign){
                if(num === 0) return "";
                else if(num === 1) return str || `${num > 0 ? "+" : ""}${num}`;
                else return `${num > 0 ? "+" : ""}${num}${str}`;
            }

            if(result.exp === 2){
                let expression = `${getTerm(result.a, `n<sup>2</sup>`)}${getTerm(result.b, `n`)}${getTerm(result.c, "")}`;
                if(expression.startsWith("+"))expression = expression.slice(1);

                document.getElementById("nth-term-data").innerHTML = `a<sub>n</sub> = ${expression}`;
            }else if(result.exp === 3){
                let expression = `${getTerm(result.a, `n<sup>3</sup>`)}${getTerm(result.b, `n<sup>2</sup>`)}${getTerm(result.c, `n`)}${getTerm(result.d, "")}`;
                if(expression.startsWith("+"))expression = expression.slice(1);

                document.getElementById("nth-term-data").innerHTML = `a<sub>n</sub> = ${expression}`;
            }
        }
    </script>

    <style>
        body>div{
            position: absolute;
            left: calc(50% - 20em);
            right: calc(50% - 20em);
            top: calc(50% - 15em);
            bottom: calc(50% - 15em);

            border: 1px solid #888;

            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            align-content: center;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div>
        <h2>Sequence Calculator</h2>
        <p> </p>
        <label>
            Sequence: [<input type="text" id="sequence-data"/>]
            <button onclick='calc(document.getElementById("sequence-data").value)'>CALC</button>
        </label>
        <p> </p>
        <label>
            n<sup>th</sup> term of sequence: 
            <p style="border: 1px solid #888; width: 30em" id="nth-term-data">need calculation</p>
        </label>
    </div>
</body>
</html>
